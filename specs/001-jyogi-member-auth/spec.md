# Feature Specification: じょぎメンバー認証システム

**Feature Branch**: `001-jyogi-member-auth`
**Created**: 2025-12-22
**Status**: Draft
**Input**: User description: "Discord OAuth2を使用したじょぎメンバー認証システム"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Discord OAuth2ログイン (Priority: P1)

じょぎメンバーが、Discordアカウントを使用して認証サーバーにログインできる。

**Why this priority**: これは認証システムの最も基本的な機能であり、すべての後続機能の基盤となる。ユーザーがシステムにアクセスする最初のステップ。

**Independent Test**: Discordログインボタンをクリックし、Discord認証画面でログインすることで、ユーザー情報（Discord ID、ユーザー名、アバター）が取得できることを確認できる。

**Acceptance Scenarios**:

1. **Given** ログインしていないユーザーがログインページにアクセス、**When** 「Discordでログイン」ボタンをクリック、**Then** Discord OAuth2認証画面にリダイレクトされる
2. **Given** Discord認証画面でログイン、**When** 認証を許可、**Then** 認証サーバーにリダイレクトされ、ユーザー情報が表示される
3. **Given** Discord認証を拒否、**When** キャンセルボタンをクリック、**Then** エラーメッセージとともにログインページに戻る

---

### User Story 2 - じょぎサーバーメンバーシップ確認 (Priority: P2)

ログインしたユーザーが、じょぎDiscordサーバーのメンバーであることを確認し、メンバーのみアクセスを許可する。

**Why this priority**: じょぎメンバー専用の認証システムとして、メンバーシップ確認は必須機能。P1のログイン機能が完成していれば独立して実装・テスト可能。

**Independent Test**: じょぎサーバーメンバーでログインした場合は認証成功、非メンバーでログインした場合はアクセス拒否されることを確認できる。

**Acceptance Scenarios**:

1. **Given** じょぎサーバーメンバーがDiscordでログイン、**When** メンバーシップ確認が実行される、**Then** 認証が成功し、ダッシュボードにアクセスできる
2. **Given** じょぎサーバー非メンバーがDiscordでログイン、**When** メンバーシップ確認が実行される、**Then** 「じょぎメンバーではありません」というエラーメッセージが表示され、アクセスが拒否される
3. **Given** メンバーシップ確認中にDiscord APIエラー、**When** エラーが発生、**Then** 適切なエラーメッセージが表示され、リトライオプションが提供される

---

### User Story 3 - JWT発行と検証 (Priority: P3)

認証成功後、アクセストークン（JWT）を発行し、後続のリクエストでトークンを検証できる。

**Why this priority**: P1とP2で認証機能が完成していれば、トークン発行は独立して実装可能。セッション管理の基盤となる。

**Independent Test**: 認証成功後にJWTが発行され、そのJWTを使って保護されたエンドポイントにアクセスできることを確認できる。

**Acceptance Scenarios**:

1. **Given** 認証に成功したユーザー、**When** JWT発行リクエストが送信される、**Then** 有効なJWT（ユーザーID、Discord ID、有効期限を含む）が返される
2. **Given** 有効なJWTを持つユーザー、**When** 保護されたエンドポイントにアクセス、**Then** リクエストが許可され、ユーザー情報が取得できる
3. **Given** 無効または期限切れのJWT、**When** 保護されたエンドポイントにアクセス、**Then** 401 Unauthorizedエラーが返される
4. **Given** JWTなしでリクエスト、**When** 保護されたエンドポイントにアクセス、**Then** 401 Unauthorizedエラーが返される

---

### User Story 4 - クライアントアプリ統合（SSO） (Priority: P4)

じょぎ内製ツール（クライアントアプリ）が、この認証サーバーを使用してユーザー認証を行える。

**Why this priority**: P1-P3で基本的な認証機能が完成していれば、SSO機能は独立して実装可能。複数のアプリケーションで認証を共有するための機能。

**Independent Test**: クライアントアプリから認証リクエストを送信し、認証成功後にクライアントアプリにリダイレクトされ、JWTが取得できることを確認できる。

**Acceptance Scenarios**:

1. **Given** クライアントアプリが認証リクエストを送信、**When** ユーザーが認証サーバーでログイン、**Then** クライアントアプリにリダイレクトされ、認可コードが付与される
2. **Given** 認可コードを受け取ったクライアントアプリ、**When** トークンエンドポイントにリクエスト、**Then** アクセストークン（JWT）とリフレッシュトークンが返される
3. **Given** 既にログイン済みのユーザー、**When** 別のクライアントアプリから認証リクエスト、**Then** 再ログインなしで自動的に認証され、クライアントアプリにリダイレクトされる（SSO）

---

### User Story 5 - セッション管理とログアウト (Priority: P5)

ユーザーのログイン状態を管理し、ログアウト機能を提供する。

**Why this priority**: P1-P4で認証とトークン発行が完成していれば、セッション管理は独立して実装可能。UX向上のための機能。

**Independent Test**: ログイン後、セッションが有効な間はアクセス可能で、ログアウト後はアクセスできないことを確認できる。

**Acceptance Scenarios**:

1. **Given** ログイン済みユーザー、**When** ログアウトボタンをクリック、**Then** セッションが無効化され、ログインページにリダイレクトされる
2. **Given** ログアウトしたユーザー、**When** 保護されたエンドポイントにアクセス、**Then** ログインページにリダイレクトされる
3. **Given** 複数のクライアントアプリでログイン中、**When** 認証サーバーでログアウト、**Then** すべてのクライアントアプリからログアウトされる（グローバルログアウト）

---

### Edge Cases

- Discordサーバーがダウンしている場合、どのようにエラーハンドリングするか？
- ユーザーがじょぎサーバーから退出した場合、既存のセッション/JWTはどうなるか？
- JWTの有効期限が切れた場合、リフレッシュトークンでどのように更新するか？
- 同時に複数のデバイスからログインした場合、セッション管理はどうなるか？
- クライアントアプリが不正な認可コードを送信した場合、どのようにエラーを返すか？
- Discord OAuth2のスコープ変更が必要な場合、既存ユーザーの再認証はどうするか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはDiscord OAuth2を使用してユーザー認証を行わなければならない
- **FR-002**: システムは認証時に、ユーザーが特定のDiscordサーバー（じょぎ）のメンバーであることを確認しなければならない
- **FR-003**: システムは認証成功後、JWT（アクセストークン）を発行しなければならない
- **FR-004**: JWTには、ユーザーID、Discord ID、ユーザー名、有効期限を含めなければならない
- **FR-005**: システムは発行されたJWTの検証機能を提供しなければならない
- **FR-006**: システムはクライアントアプリからの認証リクエストを受け付け、OAuth2認可コードフローを実装しなければならない
- **FR-007**: システムはリフレッシュトークンを発行し、アクセストークンの更新機能を提供しなければならない
- **FR-008**: システムはユーザーのログアウト機能を提供しなければならない
- **FR-009**: システムはログアウト時にセッションを無効化しなければならない
- **FR-010**: システムは認証エラー時に適切なエラーメッセージを表示しなければならない
- **FR-011**: システムはDiscord APIとの通信エラーを適切にハンドリングしなければならない
- **FR-012**: システムは環境変数から、Discord Client ID、Client Secret、Redirect URI、サーバーIDを読み込まなければならない
- **FR-013**: システムはHTTPS通信を必須とし、セキュアな通信を保証しなければならない（環境変数で開発環境のHTTP許可を制御可能）
- **FR-014**: システムはJWTの署名に秘密鍵を使用し、トークンの改ざんを防止しなければならない
- **FR-015**: システムはユーザー情報（Discord ID、ユーザー名、アバターURL）をSQLiteデータベースに永続化しなければならない
- **FR-016**: システムはデータベース抽象化層を設けて、将来的に他のデータベース（PostgreSQL等）への移行を可能にしなければならない

### Key Entities

- **User（ユーザー）**: じょぎメンバーを表すエンティティ。Discord ID、ユーザー名、アバターURL、作成日時、最終ログイン日時を持つ。
- **Session（セッション）**: ユーザーのログイン状態を表すエンティティ。セッションID、ユーザーID、作成日時、有効期限を持つ。
- **Client App（クライアントアプリ）**: 認証サーバーを使用する内製ツールを表すエンティティ。クライアントID、クライアントシークレット、リダイレクトURI、アプリ名を持つ。
- **Authorization Code（認可コード）**: OAuth2フローで使用される一時的なコード。コード、クライアントID、ユーザーID、有効期限、リダイレクトURIを持つ。
- **Token（トークン）**: アクセストークンとリフレッシュトークンを表すエンティティ。トークン値、トークンタイプ、ユーザーID、クライアントID、有効期限を持つ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: じょぎメンバーがDiscordアカウントでログインし、認証完了まで30秒以内に完了できる
- **SC-002**: じょぎサーバー非メンバーのアクセスを100%ブロックできる
- **SC-003**: システムは100件の同時ログインリクエストを処理できる
- **SC-004**: JWT検証は10ミリ秒以内に完了できる
- **SC-005**: クライアントアプリからの認証リクエストの90%が、ユーザー操作なしで自動的に認証される（SSO）
- **SC-006**: 認証エラー時、ユーザーが問題を理解できる明確なエラーメッセージが表示される
- **SC-007**: システムダウンタイムなしで、新しいクライアントアプリを追加できる
- **SC-008**: ログアウト後、すべてのアクティブセッションとトークンが無効化される

## Assumptions

- じょぎDiscordサーバーのサーバーIDは環境変数で設定される
- Discord OAuth2のスコープは `identify` と `guilds.members.read` を使用する
- JWTの有効期限はアクセストークンが1時間、リフレッシュトークンが30日とする
- クライアントアプリは事前に登録され、クライアントIDとシークレットが発行される
- HTTPS通信は本番環境で必須だが、開発環境では環境変数でHTTPを許可可能
- データベースは初期リリースでSQLiteを使用（無料運用、管理コスト0）
- データベース抽象化層を設けて、将来的なPostgreSQL等への移行を可能にする
- 想定ユーザー数: 200~500人、同時接続: 10~50人程度（SQLiteで十分対応可能）
- セッションストアは将来的にRedisなどのインメモリストアに移行可能な設計とする

## Dependencies

- Discord Developer Portal でアプリケーション登録が必要
- じょぎDiscordサーバーのサーバーIDが必要
- HTTPS証明書（本番環境）
- データベースサーバー（開発・本番環境）

## Out of Scope

以下は初期バージョンでは対象外：

- 多要素認証（MFA）
- ロールベースのアクセス制御（RBAC）- じょぎサーバー内の特定ロールによる権限管理は今後の拡張で対応
- ユーザープロフィール編集機能
- 監査ログ機能
- レート制限機能（将来的に追加予定）

### 将来の拡張計画（Phase 2以降）

以下の機能は、初期リリース後に段階的に追加予定：

**Phase 2: 基本プロフィール情報（優先度: 高）**
- じょぎメンバー固有情報をDiscordサーバーから自動取得
  - 学年
  - 学部
  - 学科
- Discord情報
  - サーバー内ロール
  - ディスプレイネーム（ニックネーム）
- 取得方法: Discord API、またはFunction等での自動取得
- 用途: 表示、将来的なアクセス制御（検討中）

**Phase 3: 機密情報管理（検討中）**
- より詳細な個人情報の管理機能
  - 本名
  - 学籍番号
- セキュリティ要件: データ暗号化、アクセス制御、適切な同意管理
- 実装時期: Phase 2完了後、必要性とセキュリティ要件を精査してから決定

**注**: Phase 2の情報はDiscordサーバー側で管理されている想定。認証システム側では、必要に応じて同期・キャッシュする設計を検討。Phase 3の機密情報については、実装前に慎重な検討が必要。
